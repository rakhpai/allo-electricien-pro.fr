{{/* Video Player Component */}}
{{/* Loads video data from data/commune_videos.json based on page slug */}}

{{ $videoData := dict }}
{{ if and .Params.slug .Site.Data.commune_videos }}
  {{ $videoData = index .Site.Data.commune_videos .Params.slug }}
{{ end }}
{{ $videoConfig := .Site.Params.video }}

{{ if and $videoData $videoConfig.enabled }}
  {{ $cityName := .Params.city | default .Title }}
  {{ $videoTitle := printf "ALLO ELECTRICIEN PRO %s" $cityName }}

  {{/* Build video paths */}}
  {{ $videoWebm := $videoData.video_webm }}
  {{ $videoMp4Compressed := $videoData.video_mp4_compressed }}
  {{ $videoMp4 := $videoData.video_mp4 }}

  {{/* Thumbnail path (CDN-aware, fallback to hero image if no video thumbnail) */}}
  {{ $thumbnailPath := "" }}
  {{ if $videoData.thumbnail_path }}
    {{ $thumbnailPath = $videoData.thumbnail_path }}
  {{ else if .Params.cdnImages.video.jpg }}
    {{/* Use CDN video thumbnail */}}
    {{ $thumbnailPath = .Params.cdnImages.video.jpg }}
  {{ else if .Params.cdnImages.hero.jpg }}
    {{/* Use CDN hero image as video poster fallback */}}
    {{ $thumbnailPath = .Params.cdnImages.hero.jpg }}
  {{ else if .Params.images.hero }}
    {{/* Use local hero image as video poster fallback */}}
    {{ $thumbnailPath = printf "/images/hero/%s.jpg" .Params.images.hero }}
  {{ end }}

  <section class="video-section">
    <div class="container mx-auto px-4">
      <div class="max-w-5xl mx-auto">

        {{/* Video Title */}}
        <h1 class="font-bold text-gray-900 mb-4 overflow-hidden text-ellipsis whitespace-nowrap" style="font-size: 1.35rem;">
          {{ $videoTitle }}
        </h1>

        {{/* Video Player Container */}}
        <div class="relative bg-gray-900 rounded-lg overflow-hidden shadow-2xl"
             style="aspect-ratio: 16/9; width: 100%;">

          <video
            id="city-video"
            class="w-full h-full"
            {{ if $thumbnailPath }}poster="{{ $thumbnailPath }}"{{ end }}
            controls
            playsinline
            {{ if $videoConfig.preload }}preload="{{ $videoConfig.preload }}"{{ else }}preload="metadata"{{ end }}
            {{ if $videoConfig.muted }}muted{{ end }}
            {{ if $videoConfig.autoplay }}autoplay{{ end }}
            width="1920"
            height="1080"
            aria-label="ALLO ELECTRICIEN PRO {{ $cityName }} - Vidéo de présentation des services 24/7">

            {{/* Prefer WebM for better compression, fallback to MP4 */}}
            {{ if $videoWebm }}
              <source src="{{ $videoWebm }}" type="video/webm">
            {{ end }}

            {{ if $videoMp4Compressed }}
              <source src="{{ $videoMp4Compressed }}" type="video/mp4">
            {{ else if $videoMp4 }}
              <source src="{{ $videoMp4 }}" type="video/mp4">
            {{ end }}

            {{/* Captions/Subtitles (if available) */}}
            {{ $vttPath := printf "/videos/captions/%s.vtt" .Params.slug }}
            {{ if (fileExists (printf "static%s" $vttPath)) }}
              <track kind="captions" src="{{ $vttPath }}" srclang="fr" label="Français" default>
            {{ end }}

            {{/* Fallback message for browsers that don't support HTML5 video */}}
            <p class="text-white p-8 text-center">
              Votre navigateur ne supporte pas la lecture de vidéos HTML5.
              <a href="{{ $videoMp4Compressed | default $videoMp4 }}" class="text-blue-400 underline" download>
                Télécharger la vidéo
              </a>
            </p>
          </video>

          {{/* Video End-Screen CTA Overlay */}}
          <div id="video-cta-overlay" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-10">
            <div class="text-center">
              <p class="text-white text-xl mb-6">Besoin d'un électricien maintenant ?</p>
              <a href="tel:{{ .Params.phoneRaw }}"
                 class="bg-emergency hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transform transition-all duration-300 hover:scale-105 inline-flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                {{ .Params.phone }}
              </a>
              <button onclick="document.getElementById('video-cta-overlay').classList.add('hidden'); document.getElementById('city-video').play();"
                      class="block mt-4 text-white/70 hover:text-white text-sm">
                Continuer à regarder
              </button>
            </div>
          </div>

        </div>

        {{/* SEO-Optimized Video Section H2 with Rotating Variants */}}
        {{ if $videoData.voiceover_script }}
          <div class="mt-8">
            {{/* Generate deterministic variant index (0-4) based on hash of city slug and zip code */}}
            {{ $citySlug := .File.BaseFileName }}
            {{ $zipCode := .Params.zipCode }}
            {{ $city := .Params.city }}
            {{ $hash := md5 (printf "%s%s" $citySlug $zipCode) }}
            {{ $hashSubstr := substr $hash 0 8 }}
            {{ $hashInt := 0 }}
            {{/* Simple hash to int conversion using character values */}}
            {{ range $i, $char := split $hashSubstr "" }}
              {{ if eq $char "a" }}{{ $hashInt = add $hashInt 10 }}{{ end }}
              {{ if eq $char "b" }}{{ $hashInt = add $hashInt 11 }}{{ end }}
              {{ if eq $char "c" }}{{ $hashInt = add $hashInt 12 }}{{ end }}
              {{ if eq $char "d" }}{{ $hashInt = add $hashInt 13 }}{{ end }}
              {{ if eq $char "e" }}{{ $hashInt = add $hashInt 14 }}{{ end }}
              {{ if eq $char "f" }}{{ $hashInt = add $hashInt 15 }}{{ end }}
              {{ if eq $char "0" }}{{ $hashInt = add $hashInt 0 }}{{ end }}
              {{ if eq $char "1" }}{{ $hashInt = add $hashInt 1 }}{{ end }}
              {{ if eq $char "2" }}{{ $hashInt = add $hashInt 2 }}{{ end }}
              {{ if eq $char "3" }}{{ $hashInt = add $hashInt 3 }}{{ end }}
              {{ if eq $char "4" }}{{ $hashInt = add $hashInt 4 }}{{ end }}
              {{ if eq $char "5" }}{{ $hashInt = add $hashInt 5 }}{{ end }}
              {{ if eq $char "6" }}{{ $hashInt = add $hashInt 6 }}{{ end }}
              {{ if eq $char "7" }}{{ $hashInt = add $hashInt 7 }}{{ end }}
              {{ if eq $char "8" }}{{ $hashInt = add $hashInt 8 }}{{ end }}
              {{ if eq $char "9" }}{{ $hashInt = add $hashInt 9 }}{{ end }}
            {{ end }}
            {{ $variantIndex := mod $hashInt 5 }}

            {{/* Define 5 SEO-optimized variant templates */}}
            {{ $variant0 := printf "Vidéo ALLO ELECTRICIEN PRO %s (%s) - Dépannage 24/7" $city $zipCode }}
            {{ $variant1 := printf "Présentation Vidéo - Électricien Urgence %s (%s)" $city $zipCode }}
            {{ $variant2 := printf "Vidéo Dépannage Électrique 24h/24 %s (%s)" $city $zipCode }}
            {{ $variant3 := printf "Découvrez Votre Électricien SOS %s (%s) en Vidéo" $city $zipCode }}
            {{ $variant4 := printf "Intervention Urgence Électricien %s (%s) - Vidéo 24/7" $city $zipCode }}

            {{ $selectedVariant := "" }}
            {{ if eq $variantIndex 0 }}{{ $selectedVariant = $variant0 }}{{ end }}
            {{ if eq $variantIndex 1 }}{{ $selectedVariant = $variant1 }}{{ end }}
            {{ if eq $variantIndex 2 }}{{ $selectedVariant = $variant2 }}{{ end }}
            {{ if eq $variantIndex 3 }}{{ $selectedVariant = $variant3 }}{{ end }}
            {{ if eq $variantIndex 4 }}{{ $selectedVariant = $variant4 }}{{ end }}

            {{/* H2 heading with toggle icon at the end */}}
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-900">
                {{ $selectedVariant }}
              </h2>
              <button type="button"
                      id="transcript-toggle"
                      class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                      aria-expanded="false"
                      aria-controls="transcript-content"
                      aria-label="Afficher/masquer la transcription vidéo">
                <svg class="w-7 h-7 text-primary transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>

            {{/* Collapsible Video Transcript */}}
            <div id="transcript-content" class="hidden mt-4 bg-gray-50 rounded-lg p-6 transition-all duration-300">
              {{/* Define 5 SEO-optimized H3 variant templates */}}
              {{ $h3variant0 := printf "Transcription Complète - Électricien %s (%s)" $city $zipCode }}
              {{ $h3variant1 := printf "Détails Services Électricien %s (%s)" $city $zipCode }}
              {{ $h3variant2 := printf "Contenu Vidéo Électricien Urgence %s" $city }}
              {{ $h3variant3 := printf "Présentation Complète Électricien %s (%s)" $city $zipCode }}
              {{ $h3variant4 := printf "Texte Intégral Vidéo Dépannage %s" $city }}

              {{ $selectedH3 := "" }}
              {{ if eq $variantIndex 0 }}{{ $selectedH3 = $h3variant0 }}{{ end }}
              {{ if eq $variantIndex 1 }}{{ $selectedH3 = $h3variant1 }}{{ end }}
              {{ if eq $variantIndex 2 }}{{ $selectedH3 = $h3variant2 }}{{ end }}
              {{ if eq $variantIndex 3 }}{{ $selectedH3 = $h3variant3 }}{{ end }}
              {{ if eq $variantIndex 4 }}{{ $selectedH3 = $h3variant4 }}{{ end }}

              <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>{{ $selectedH3 }}</span>
              </h3>
              <p class="text-gray-700 whitespace-pre-line leading-relaxed text-base">
                {{ $videoData.voiceover_script }}
              </p>

              {{ if $videoData.created_at }}
              <div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                <span>Vidéo mise en ligne le {{ dateFormat "2 January 2006" $videoData.created_at }}</span>
              </div>
              {{ end }}
            </div>
          </div>
        {{ end }}

      </div>
    </div>
  </section>

  {{/* Video Analytics Tracking Script */}}
  <script>
  (function() {
    const video = document.getElementById('city-video');
    if (!video) return;

    const videoData = {
      title: '{{ $videoTitle }}',
      city: '{{ .Params.city }}',
      slug: '{{ .Params.slug }}'
    };

    // Track milestones
    const milestones = {25: false, 50: false, 75: false, 100: false};

    video.addEventListener('play', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'video_start', {
          video_title: videoData.title,
          video_city: videoData.city,
          video_current_time: 0
        });
      }
    });

    video.addEventListener('timeupdate', function() {
      if (!video.duration) return;

      const percent = Math.floor((video.currentTime / video.duration) * 100);

      Object.keys(milestones).forEach(milestone => {
        if (percent >= milestone && !milestones[milestone]) {
          milestones[milestone] = true;

          if (typeof gtag !== 'undefined') {
            gtag('event', 'video_progress', {
              video_title: videoData.title,
              video_city: videoData.city,
              video_percent: milestone
            });
          }
        }
      });
    });

    video.addEventListener('ended', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'video_complete', {
          video_title: videoData.title,
          video_city: videoData.city
        });
      }

      // Show CTA overlay after video ends
      const ctaOverlay = document.getElementById('video-cta-overlay');
      if (ctaOverlay) {
        ctaOverlay.classList.remove('hidden');
      }
    });

    video.addEventListener('pause', function() {
      if (video.currentTime < video.duration - 1) {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'video_pause', {
            video_title: videoData.title,
            video_city: videoData.city,
            video_current_time: Math.floor(video.currentTime)
          });
        }
      }
    });

    // Track and handle transcript toggle
    const toggleButton = document.getElementById('transcript-toggle');
    const transcriptContent = document.getElementById('transcript-content');
    if (toggleButton && transcriptContent) {
      toggleButton.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        const newState = !isExpanded;

        // Update ARIA state
        this.setAttribute('aria-expanded', newState);

        // Toggle content visibility
        transcriptContent.classList.toggle('hidden');

        // Rotate icon
        this.querySelector('svg').classList.toggle('rotate-180');

        // Track analytics
        if (typeof gtag !== 'undefined') {
          gtag('event', 'video_transcript_toggle', {
            city: videoData.city,
            state: newState ? 'expanded' : 'collapsed'
          });
        }
      });
    }
  })();
  </script>

{{ end }}
