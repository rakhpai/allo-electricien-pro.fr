{{/*
  Sidebar Video Links Card
  Displays 8 SEO-optimized links to video pages sitewide
  Uses deterministic hash-based selection for consistency
*/}}

{{ $allVideos := .Site.Data.commune_videos }}
{{ $currentSlug := .Params.slug }}
{{ $currentDept := .Params.department | default "" }}

{{ if and $allVideos $currentSlug }}

{{/* Step 1: Convert to slice and exclude current page */}}
{{ $videoList := slice }}
{{ range $slug, $data := $allVideos }}
  {{ if ne $slug $currentSlug }}
    {{ $entry := dict "slug" $slug "city" $data.city_name "dept" $data.department "zip" $data.commune_code }}
    {{ $videoList = $videoList | append $entry }}
  {{ end }}
{{ end }}

{{/* Step 2: Deterministic hash-based selection */}}
{{ $hash := md5 $currentSlug }}
{{ $hashInt := 0 }}
{{/* Convert first 8 hex chars to int for seeding */}}
{{ $hashSubstr := substr $hash 0 8 }}
{{ range $i, $char := split $hashSubstr "" }}
  {{ if eq $char "a" }}{{ $hashInt = add $hashInt 10 }}{{ end }}
  {{ if eq $char "b" }}{{ $hashInt = add $hashInt 11 }}{{ end }}
  {{ if eq $char "c" }}{{ $hashInt = add $hashInt 12 }}{{ end }}
  {{ if eq $char "d" }}{{ $hashInt = add $hashInt 13 }}{{ end }}
  {{ if eq $char "e" }}{{ $hashInt = add $hashInt 14 }}{{ end }}
  {{ if eq $char "f" }}{{ $hashInt = add $hashInt 15 }}{{ end }}
  {{ if eq $char "0" }}{{ $hashInt = add $hashInt 0 }}{{ end }}
  {{ if eq $char "1" }}{{ $hashInt = add $hashInt 1 }}{{ end }}
  {{ if eq $char "2" }}{{ $hashInt = add $hashInt 2 }}{{ end }}
  {{ if eq $char "3" }}{{ $hashInt = add $hashInt 3 }}{{ end }}
  {{ if eq $char "4" }}{{ $hashInt = add $hashInt 4 }}{{ end }}
  {{ if eq $char "5" }}{{ $hashInt = add $hashInt 5 }}{{ end }}
  {{ if eq $char "6" }}{{ $hashInt = add $hashInt 6 }}{{ end }}
  {{ if eq $char "7" }}{{ $hashInt = add $hashInt 7 }}{{ end }}
  {{ if eq $char "8" }}{{ $hashInt = add $hashInt 8 }}{{ end }}
  {{ if eq $char "9" }}{{ $hashInt = add $hashInt 9 }}{{ end }}
{{ end }}

{{/* Step 3: Separate by department (60% same, 40% other) */}}
{{ $sameDept := slice }}
{{ $otherDept := slice }}
{{ range $videoList }}
  {{ if eq .dept $currentDept }}
    {{ $sameDept = $sameDept | append . }}
  {{ else }}
    {{ $otherDept = $otherDept | append . }}
  {{ end }}
{{ end }}

{{/* Step 4: Deterministic selection (8 total) */}}
{{ $selected := slice }}
{{ $targetSame := 5 }}
{{ $targetOther := 3 }}

{{/* Select from same department */}}
{{ if gt (len $sameDept) 0 }}
  {{ range $i := seq 0 (sub (len $sameDept) 1) }}
    {{ $index := mod (add $hashInt $i) (len $sameDept) }}
    {{ $selected = $selected | append (index $sameDept $index) }}
    {{ if ge (len $selected) $targetSame }}{{ break }}{{ end }}
  {{ end }}
{{ end }}

{{/* Fill with other departments if needed */}}
{{ $remaining := sub 8 (len $selected) }}
{{ if and (gt (len $otherDept) 0) (gt $remaining 0) }}
  {{ range $i := seq 0 (sub (len $otherDept) 1) }}
    {{ $index := mod (add $hashInt $i 100) (len $otherDept) }}
    {{ $selected = $selected | append (index $otherDept $index) }}
    {{ if ge (len $selected) 8 }}{{ break }}{{ end }}
  {{ end }}
{{ end }}

{{/* Only show if we have videos to display */}}
{{ if gt (len $selected) 0 }}

<!-- Video Links Sidebar Card -->
<div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg shadow-lg p-6 mb-8 lg:pt-[90px]">
  <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
    </svg>
    Découvrez Nos Services en Vidéo
  </h3>

  <p class="text-gray-700 text-sm mb-4">
    Présentations vidéo de nos électriciens en Île-de-France
  </p>

  <ul class="space-y-4">
    {{ range $index, $video := $selected }}
      {{/* Generate varied anchor text based on index */}}
      {{ $anchorVariant := mod $index 7 }}
      {{ $anchor := "" }}
      {{ $cityName := $video.city }}
      {{ $zipCode := $video.zip }}
      {{ $dept := $video.dept }}

      {{ if eq $anchorVariant 0 }}
        {{ $anchor = printf "Vidéo Électricien %s (%s)" $cityName $zipCode }}
      {{ else if eq $anchorVariant 1 }}
        {{ $anchor = printf "Découvrez nos services à %s en vidéo" $cityName }}
      {{ else if eq $anchorVariant 2 }}
        {{ $anchor = printf "Présentation vidéo - Dépannage %s" $cityName }}
      {{ else if eq $anchorVariant 3 }}
        {{ $anchor = printf "Voir notre électricien à %s" $cityName }}
      {{ else if eq $anchorVariant 4 }}
        {{ $anchor = printf "Électricien %s - Vidéo %s" $dept $cityName }}
      {{ else if eq $anchorVariant 5 }}
        {{ $anchor = printf "Urgence électrique %s - Présentation vidéo" $cityName }}
      {{ else if eq $anchorVariant 6 }}
        {{ $anchor = printf "SOS Électricien %s en images" $cityName }}
      {{ end }}

      <li>
        <a href="/{{ $video.slug }}/"
           class="flex items-center gap-2 text-sm text-gray-700 hover:text-primary hover:underline transition-colors group"
           title="{{ $anchor }} - Service électricien professionnel">
          <svg class="w-4 h-4 text-purple-500 flex-shrink-0 group-hover:text-primary transition-colors"
               fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
          </svg>
          <span>{{ $anchor }}</span>
        </a>
      </li>
    {{ end }}
  </ul>

  <div class="mt-4 pt-4 border-t border-purple-200 text-center">
    <p class="text-xs text-gray-600">
      {{ len $selected }} présentations vidéo disponibles
    </p>
  </div>
</div>

{{ end }}
{{ end }}
